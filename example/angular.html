<!doctype html>
<html lang="en" ng-app="demo">
	<head>

		<meta charset="utf-8">
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/angular-ui.min.css">
		<link rel="stylesheet" href="css/select2.css">

		<style type="text/css" media="all">
			:disabled, [disabled=disabled]
			{
				cursor: not-allowed !important;
			}

			.select2-container
			{
				min-width: 300px;
				margin-right: 5px;
			}
		</style>

		<title>lfswsrelay.js :: an angular example</title>

	</head>
	<body>

		<div class="container" ng-controller="Cntrl">

			<h1>lfswsrelay.js <small>an angular example...</small></h1>
			<p>There's plenty you could do with the <acronym
				title="LiveForSpeed">LFS</acronym> WebSocket
			InSim relay. This is just an example.</p>

			<div class="row">
				<div class="span12 btn-group-wrap">

					<p>Value is: {{select2}} </p>

					
					<select ui-select2="{allowClear:true}" ng-model="select2">
							<option ng-repeat="i in hosts" value="{{i.hname}}">{{i.hname | stripcodes}}</option>
					</select>


					<div class="btn-toolbar">
						<div class="btn-group">
							<button class="btn btn-small btn-success"
								ng-click="connectToggle()"
								ng-disabled="connected"><i class="icon-off
									icon-white"></i> Connect to relay</button>
							<button class="btn btn-small btn-danger"
								ng-click="connectToggle()"
								ng-disabled="!connected"><i class="icon-off
									icon-white"></i> Disconnect from relay</button>
						</div>

						<div class="btn-group">

							<button class="btn btn-small"
								ng-click="listHosts()"
								ng-disabled="!connected"><i class="icon-refresh"></i> Refresh Host List</button>
							<button class="btn btn-small"
								ng-click="clearHosts()"><i class="icon-remove"></i> Clear Host List</button>
						</div>

					</div>
				</div>
			</div>

			<div class="row">

				<div class="span8">
					<h2>Hosts</h2>
					<table class="table table-condensed table-hover">
						<thead>
							<tr>
								<th>Hostname</th>
								<th>Track</th>
								<th># Connections</th>
							</tr>
						</thead>
						<tbody ng-repeat="i in hosts">
							<tr>
								<td>{{i.hname | stripcodes}}</td>
								<td>{{i.track}}</td>
								<td>{{i.numconns}}</td>
							</tr>
						</tbody>
					</table>
				</div>

				<div class="span4">
					<h2>Log</h2>
					<p>Last 10 log items</p>
					<ul ng-repeat="item in log.slice(0, 10)">
						<li>{{item}}</li>
					</ul>
				</div>

			</div>
		</div>

		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

		<script type="text/javascript" charset="utf-8" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/angular-ui.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/select2.min.js"></script>

		<script type="text/javascript" charset="utf-8" src="../lib/struct.js"></script>
		<script type="text/javascript" charset="utf-8" src="../lib/event.js"></script>
		<script type="text/javascript" charset="utf-8" src="../lib/relay.js"></script>


		<script type="text/javascript" charset="utf-8">

			var demo = angular.module('demo', [ 'ui' ]);

			// you shouldn't do this in a real world scenario - this shit needs
			// translating properly
			demo.filter('stripcodes', function ()
			{
				return function (text)
				{
					return text.replace(/\^[0-9\^LGCJETBHSK]/g, '');
				};
			});

			demo.controller(
				"Cntrl",
				function($scope)
				{
					$scope.$safeApply = function(fn)
					{
						var phase = this.$root.$$phase;
						if(phase == '$apply' || phase == '$digest')
						{
							fn();
							return;
						}
						this.$apply(fn);
  					}

					$scope.select2 = '';
					$scope.log = [];
					$scope.hosts = [];
					$scope.connected = false;

					var client = new lfswsrelay.client();

					client.on('connected', function()
					{
						$scope.$safeApply( function()
						{
							$scope.log.unshift('connected');
						});
					});
	
					client.on('IS_TINY', function(data)
					{
						if (data.subt == 0)
						$scope.$safeApply( function()
						{
							$scope.log.unshift('keep alive');
						});
					});
			
					client.on('IR_HOS', function(data)
					{
						$scope.$safeApply( function()
						{
							$scope.log.unshift('received host packet');

							for (var i in data.info)
								$scope.hosts.push(data.info[i]);
						});
					});
			
					client.on('disconnected', function()
					{
						$scope.$safeApply( function()
						{
							$scope.log.unshift('disconnected');
						});
					});

					$scope.connectToggle = function()
					{
						if (!$scope.connected)
						{
							client.connect();
							$scope.connected = true;
							return;
						}
						
						client.disconnect();
						$scope.connected = false;		
					}

					$scope.listHosts = function()
					{
						if (!$scope.connected)
							return;

						$scope.$safeApply( function()
						{
							$scope.log.unshift('requested host list');
							$scope.hosts = [];
						});

						var payload = new lfswsrelay.packets.IR_HLR().pack();
						client.send(payload);
					}

					$scope.clearHosts = function()
					{
						$scope.$safeApply( function()
						{
							$scope.log.unshift('cleared host list');
							$scope.hosts = [];
						});
					}

				}
			);
		</script>
	</body>
</html>
